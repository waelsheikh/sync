# توثيق نظام المزامنة بين أنظمة Odoo

## 1. الغرض العام من البرنامج

هذا البرنامج هو أداة مساعدة (CLI tool) مصممة لمزامنة البيانات بين نظامي Odoo مختلفين (عادةً من نظام Odoo Community كمصدر إلى نظام Odoo Enterprise/Online كوجهة). يهدف البرنامج إلى نقل السجلات الأساسية والحركات المحاسبية بشكل موثوق، مع دعم المزامنة التزايدية (Incremental Synchronization) وتحديث السجلات الموجودة.

## 2. نظرة عامة على البنية (Architecture Overview)

يعتمد البرنامج على بنية معيارية (Modular Architecture) لسهولة التوسع والصيانة. تتكون البنية الأساسية من المكونات التالية:

*   **`SyncEngine` (محرك المزامنة)**: هو المنسق الرئيسي للعملية. يقوم بتهيئة الاتصالات، وإدارة حالة المزامنة (مثل آخر وقت مزامنة)، وتسجيل وتشغيل وحدات المزامنة المتخصصة.
*   **`ConfigManager` (مدير الإعدادات)**: مسؤول عن قراءة إعدادات الاتصال من ملف `config.ini`.
*   **`OdooConnector` (موصل Odoo)**: يوفر واجهة للاتصال بواجهة برمجة تطبيقات Odoo (API) وتنفيذ العمليات الأساسية مثل البحث، القراءة، الإنشاء، التحديث، والتحقق من الحقول المخصصة.
*   **`SyncKeyManager` (مدير مفاتيح المزامنة)**: يدير قاعدة بيانات SQLite محلية (`sync_map.db`) لتخزين الربط بين معرفات السجلات في نظام المصدر ومعرفاتها المقابلة في نظام الوجهة. هذا ضروري لتتبع السجلات التي تمت مزامنتها.
*   **`Sync Modules` (وحدات المزامنة)**: هي وحدات متخصصة (مثل `ContactSyncModule`, `InvoiceSyncModule`)، كل منها مسؤول عن مزامنة نوع معين من السجلات. يتم تسجيل هذه الوحدات في `SyncEngine` وتشغيلها بترتيب منطقي لضمان سلامة البيانات.

## 3. توثيق الملفات والمكونات

### الملفات الجذرية

*   **`main.py`**
    *   **الغرض**: نقطة الدخول الرئيسية للتطبيق. يقوم بتهيئة `SyncEngine`، وتسجيل جميع وحدات المزامنة المطلوبة بالترتيب الصحيح، ثم يشغل عملية المزامنة الكاملة.
    *   **الوظائف الرئيسية**:
        *   `main()`: الدالة الرئيسية التي تحتوي على منطق التشغيل.
        *   استيراد وتسجيل جميع وحدات المزامنة من مجلد `modules/`.
    *   **الاعتماديات**: `sync_engine.py` وجميع ملفات الوحدات في `modules/`.

*   **`config_manager.py`**
    *   **الغرض**: إدارة قراءة إعدادات الاتصال بـ Odoo من ملف `config.ini`.
    *   **الفئات الرئيسية**:
        *   `ConfigManager`:
            *   `__init__()`: يقوم بتحميل الإعدادات من `config.ini`.
            *   `get_community_credentials()`: يسترجع بيانات اعتماد نظام Odoo Community (المصدر).
            *   `get_online_credentials()`: يسترجع بيانات اعتماد نظام Odoo Enterprise/Online (الوجهة).
    *   **الاعتماديات**: لا توجد اعتماديات داخلية، يعتمد على ملف `config.ini` الخارجي.

*   **`odoo_connector.py`**
    *   **الغرض**: توفير طبقة تجريدية للاتصال بواجهة برمجة تطبيقات Odoo (RPC) وتنفيذ العمليات. كما يتولى مسؤولية التحقق من وجود وإنشاء الحقول المخصصة في نظام الوجهة.
    *   **الفئات الرئيسية**:
        *   `OdooConnector`:
            *   `__init__(credentials)`: يقوم بإنشاء اتصال Odoo باستخدام بيانات الاعتماد المقدمة.
            *   `get_api()`: يعيد كائن API المتصل بـ Odoo.
            *   `ensure_custom_field(model, field_name, field_label, field_type)`: يتحقق من وجود حقل مخصص في نموذج معين، وإذا لم يكن موجودًا، يقوم بإنشائه.
    *   **الاعتماديات**: مكتبة `odoorpc`.

*   **`sync_engine.py`**
    *   **الغرض**: النواة الأساسية ومحرك المزامنة. ينسق عملية المزامنة بأكملها، ويهيئ الخدمات، ويدير دورة حياة وحدات المزامنة.
    *   **الفئات الرئيسية**:
        *   `SyncEngine`:
            *   `__init__()`: يهيئ `ConfigManager`، `SyncKeyManager`، و `OdooConnector` للمصدر والوجهة.
            *   `_read_last_sync_time()`: يقرأ آخر طابع زمني للمزامنة الناجحة من ملف `last_sync_time.txt`.
            *   `_write_last_sync_time()`: يكتب الطابع الزمني الحالي (بتوقيت UTC) إلى `last_sync_time.txt` بعد اكتمال المزامنة بنجاح.
            *   `_initialize_services()`: يقوم بتهيئة جميع الموصلات ومديري الإعدادات والمفاتيح، ويتحقق من وجود الحقول المخصصة الأساسية في الوجهة.
            *   `register_module(module_class)`: يسجل وحدة مزامنة لتشغيلها لاحقًا، ويمرر لها الاتصالات ومدير المفاتيح وآخر وقت مزامنة.
            *   `run_sync()`: يشغل جميع وحدات المزامنة المسجلة بالترتيب.
    *   **الاعتماديات**: `config_manager.py`, `sync_key_manager.py`, `odoo_connector.py`.

*   **`sync_key_manager.py`**
    *   **الغرض**: إدارة قاعدة بيانات SQLite محلية (`sync_map.db`) لتخزين الربط بين معرفات السجلات في نظام المصدر ومعرفاتها في نظام الوجهة.
    *   **الفئات الرئيسية**:
        *   `SyncKeyManager`:
            *   `__init__()`: يتصل بقاعدة بيانات `sync_map.db` وينشئ جدول `sync_map` إذا لم يكن موجودًا.
            *   `add_mapping(model, source_id, destination_id)`: يضيف أو يحدث ربطًا جديدًا في قاعدة البيانات.
            *   `get_destination_id(model, source_id)`: يسترجع معرف الوجهة المقابل لمعرف المصدر ونوع النموذج.
            *   `close_connection()`: يغلق الاتصال بقاعدة البيانات.
    *   **الاعتماديات**: مكتبة `sqlite3`.

*   **`setup.py`**
    *   **الغرض**: ملف إعداد المشروع (عادةً لتثبيت الحزم). لم يتم استخدامه بشكل مباشر في سياق هذا التوثيق، ولكنه جزء قياسي من مشاريع Python.

### مجلد `modules/` (وحدات المزامنة)

كل وحدة مزامنة في هذا المجلد تتبع نمطًا مشابهًا:

*   **`MODEL`**: اسم نموذج Odoo الذي تتعامل معه الوحدة (مثال: `res.partner`, `account.move`).
*   **`FIELDS_TO_SYNC`**: قائمة بالحقول التي يجب جلبها من المصدر ومزامنتها.
*   **`__init__(self, source_conn, dest_conn, key_manager, last_sync_time)`**: تهيئة الوحدة مع كائنات الاتصال ومدير المفاتيح وآخر وقت مزامنة.
*   **`run()`**: نقطة الدخول الرئيسية للوحدة. تحتوي على منطق جلب السجلات من المصدر (مع فلترة `write_date` للمزامنة التزايدية) والمرور عليها لمزامنتها.
*   **`_sync_record(self, source_record, ...)`**: دالة خاصة لمزامنة سجل فردي. تحدد ما إذا كان يجب تحديث سجل موجود أو إنشاء سجل جديد.
*   **`_transform_data(self, source_record, ...)`**: دالة لتحويل بيانات السجل من تنسيق المصدر إلى تنسيق مناسب للوجهة، ومعالجة العلاقات (مثل `Many2One`, `Many2Many`).

**الوحدات المحددة:**

*   **`modules/contacts_sync.py`**
    *   **النموذج**: `res.partner` (جهات الاتصال).
    *   **المنطق الخاص**: يتعامل مع `country_id` (ربط البلدان).
    *   **حقل المزامنة**: `x_partner_sync_id`.

*   **`modules/company_sync.py`**
    *   **النموذج**: `res.company` (الشركات).
    *   **المنطق الخاص**: لا يستخدم `write_date` للمزامنة التزايدية (يقوم دائمًا بمزامنة كاملة للشركات لضمان وجودها). يتعامل مع `currency_id`.
    *   **حقل المزامنة**: `x_company_sync_id`.

*   **`modules/accounts_sync.py`**
    *   **النموذج**: `account.account` (شجرة الحسابات).
    *   **المنطق الخاص**: يتعامل مع `company_ids` لربط الحسابات بالشركات الصحيحة.
    *   **حقل المزامنة**: `x_account_sync_id`.

*   **`modules/journals_sync.py`**
    *   **النموذج**: `account.journal` (دفاتر اليومية).
    *   **المنطق الخاص**: يتعامل مع `default_account_id` و `company_id`.
    *   **حقل المزامنة**: `x_journal_sync_id`.

*   **`modules/taxes_sync.py`**
    *   **النموذج**: `account.tax` (الضرائب).
    *   **المنطق الخاص**: يتعامل مع `company_id` و `type_tax_use`.
    *   **حقل المزامنة**: `x_tax_sync_id`.

*   **`modules/invoices_sync.py`**
    *   **النموذج**: `account.move` (الفواتير).
    *   **المنطق الخاص**:
        *   **المزامنة التزايدية**: يبحث عن التغييرات في `account.move` (الرأس) و `account.move.line` (السطور) باستخدام `write_date`، ثم يجمع المعرفات الفريدة للفواتير المتأثرة.
        *   **تحديث المستندات المرحّلة**: يستخدم منطق "فك الترحيل - التحديث - إعادة الترحيل" (`button_draft()` ثم `write()` ثم `action_post()`) لتحديث الفواتير المرحّلة.
        *   ربط `partner_id`, `journal_id`, `account_id`, `tax_ids` باستخدام حقول `x_MODEL_sync_id` المقابلة.
        *   يضيف حقول التدقيق `x_original_source_id` و `x_original_write_date` إلى الفاتورة في الوجهة.
    *   **حقل المزامنة**: `x_move_sync_id`.

*   **`modules/journal_entries_sync.py`**
    *   **النموذج**: `account.move` (قيود اليومية).
    *   **المنطق الخاص**:
        *   **المزامنة التزايدية**: يبحث عن التغييرات في `account.move` (الرأس) و `account.move.line` (السطور) باستخدام `write_date`، ثم يجمع المعرفات الفريدة لقيود اليومية المتأثرة.
        *   **تحديث المستندات المرحّلة**: يستخدم منطق "فك الترحيل - التحديث - إعادة الترحيل" (`button_draft()` ثم `write()` ثم `action_post()`) لتحديث قيود اليومية المرحّلة.
        *   ربط `journal_id`, `account_id`, `partner_id` باستخدام حقول `x_MODEL_sync_id` المقابلة.
        *   يضيف حقول التدقيق `x_original_source_id` و `x_original_write_date` إلى القيد في الوجهة.
    *   **حقل المزامنة**: `x_move_sync_id`.

## 4. تفاصيل منطق المزامنة

*   **المزامنة التزايدية (Incremental Sync)**:
    *   يعتمد على حقل `write_date` الموجود في جميع سجلات Odoo.
    *   يتم تخزين آخر وقت مزامنة ناجحة (بتوقيت UTC) في ملف `last_sync_time.txt`.
    *   في كل تشغيل، تقوم وحدات المزامنة بالبحث عن السجلات التي تم تعديلها (`write_date > last_sync_time`) في نظام المصدر.
    *   بالنسبة للنماذج ذات السطور (مثل الفواتير وقيود اليومية)، يتم البحث عن التغييرات في كل من السجل الرئيسي (account.move) وسطوره (account.move.line) لضمان اكتشاف جميع التعديلات.

*   **تحديد السجلات (Record Identification)**:
    *   يتم استخدام حقول مخصصة في نظام الوجهة لتخزين معرف المصدر لكل سجل. هذه الحقول تتبع التسمية `x_MODEL_sync_id` (مثال: `x_partner_sync_id`, `x_account_sync_id`, `x_move_sync_id`).
    *   عند مزامنة سجل، يبحث البرنامج أولاً في الوجهة عن سجل يحمل نفس `x_MODEL_sync_id`.
    *   إذا تم العثور عليه، يتم تحديث السجل الموجود.
    *   إذا لم يتم العثور عليه، يتم إنشاء سجل جديد.

*   **ربط السجلات المرتبطة (Related Record Mapping)**:
    *   عند تحويل البيانات، يتم البحث عن معرفات السجلات المرتبطة (مثل `partner_id`, `journal_id`, `account_id`) مباشرة في نظام الوجهة باستخدام حقول `x_MODEL_sync_id` الخاصة بها.

*   **تحديث المستندات المرحّلة (Posted Document Updates)**:
    *   بالنسبة للفواتير وقيود اليومية (نماذج `account.move`)، لا يمكن تعديلها مباشرة إذا كانت في حالة "مرحّلة" (`posted`).
    *   يقوم البرنامج بتنفيذ تسلسل من العمليات:
        1.  إلغاء ترحيل المستند إلى حالة "مسودة" (`button_draft()`).
        2.  تحديث بيانات المستند وسطوره.
        3.  إعادة ترحيل المستند إلى حالة "مرحّلة" (`action_post()`).

*   **حقول التدقيق (Audit Fields)**:
    *   يتم إضافة حقلين مخصصين (`x_original_source_id` و `x_original_write_date`) إلى نموذج `account.move` في الوجهة لتخزين المعرف الأصلي للسجل وتاريخ آخر تحديث له من نظام المصدر. هذه الحقول مفيدة للتدقيق وتتبع مصدر البيانات.

## 5. تعليمات الإعداد والاستخدام

### المتطلبات المسبقة

*   Python 3.x
*   بيئة افتراضية (venv موصى بها)
*   وصول API إلى نظامي Odoo (المصدر والوجهة).

### خطوات الإعداد

1.  **استنساخ المستودع (Clone the Repository)**:
    ```bash
    git clone <رابط المستودع>
    cd <اسم مجلد المشروع>
    ```

2.  **إنشاء وتفعيل البيئة الافتراضية**:
    ```bash
    python -m venv venv
    .\venv\Scripts\activate   # على Windows PowerShell
    # source venv/bin/activate # على Linux/macOS
    ```

3.  **تثبيت الاعتماديات**:
    ```bash
    pip install odoorpc
    ```

4.  **إعداد ملف `config.ini`**:
    أنشئ ملفًا باسم `config.ini` في المجلد الجذري للمشروع بالصيغة التالية، واملأ بيانات الاعتماد الخاصة بك:
    ```ini
    [odoo_community]
    host = localhost
    port = 8069
    database = odoo_community_db
    username = admin
    password = admin_password

    [odoo_online]
    host = your_online_instance.odoo.com
    port = 443
    database = your_online_db
    username = your_email@example.com
    password = your_online_password
    ```
    **ملاحظة**: تأكد من أن `host` لـ `odoo_online` لا يحتوي على `http://` أو `https://`.

5.  **إعداد الحقول المخصصة في Odoo الوجهة (برمجيًا)**:
    البرنامج مصمم لإنشاء الحقول المخصصة تلقائيًا عند التشغيل الأول إذا لم تكن موجودة. هذه الحقول هي:
    *   `res.partner`: `x_partner_sync_id` (Char)
    *   `res.company`: `x_company_sync_id` (Char)
    *   `account.account`: `x_account_sync_id` (Char)
    *   `account.journal`: `x_journal_sync_id` (Char)
    *   `account.tax`: `x_tax_sync_id` (Char)
    *   `account.move`: `x_move_sync_id` (Char), `x_original_source_id` (Integer), `x_original_write_date` (Datetime)

    **ملاحظة هامة**: إذا كنت قد أنشأت أيًا من هذه الحقول يدويًا بأسماء مختلفة سابقًا، فقد تحتاج إلى حذفها أو إعادة تسميتها في Odoo Studio لتجنب التعارضات.

### خطوات التشغيل

1.  **تنظيف بيئة الاختبار (للتشغيل الأول أو لإعادة المزامنة من الصفر)**:
    *   **احذف ملف `sync_map.db`**: هذا الملف يخزن الربط بين المعرفات. حذفه يجبر البرنامج على إعادة بناء الربط.
    *   **احذف ملف `last_sync_time.txt`**: هذا الملف يخزن آخر وقت مزامنة. حذفه يجبر البرنامج على إجراء مزامنة كاملة.
    *   **احذف البيانات من نظام Odoo الوجهة**: لضمان مزامنة نظيفة، يوصى بحذف السجلات التي سيتم مزامنتها من نظام الوجهة (مثل جهات الاتصال، الشركات، الفواتير، قيود اليومية).

2.  **تشغيل المزامنة**:
    ```bash
    python main.py
    ```

### اختبار المزامنة التزايدية

بعد التشغيل الأول الناجح:

1.  **قم بإجراء تغيير في نظام Odoo المصدر**:
    *   عدّل سجلًا موجودًا (مثال: تغيير رقم هاتف جهة اتصال، تعديل كمية في سطر فاتورة مرحّلة، إضافة سطر جديد لقيد يومية مرحّل).
    *   تأكد أن التغيير الذي قمت به قد حدث بعد آخر وقت مزامنة مسجل في `last_sync_time.txt`.

2.  **أعد تشغيل السكربت**:
    ```bash
    python main.py
    ```
    يجب أن يقوم السكربت الآن باكتشاف وتحديث السجلات التي تم تغييرها فقط.

## 6. تحسينات واعتبارات مستقبلية

*   **معالجة الأخطاء المتقدمة**: تنفيذ آليات إعادة المحاولة (retries) أو تسجيل الأخطاء (logging) إلى ملف أو خدمة خارجية.
*   **التحقق من البيانات**: إضافة المزيد من التحقق من صحة البيانات قبل الإنشاء/التحديث لضمان جودة البيانات.
*   **دعم المنتجات**: إضافة وحدة مزامنة للمنتجات (product.product) إذا كانت الفواتير تعتمد عليها.
*   **الجدولة**: دمج السكربت مع أداة جدولة (مثل Cron jobs على Linux أو Task Scheduler على Windows) لتشغيله تلقائيًا.
*   **التكوين الديناميكي**: السماح بتكوين وحدات المزامنة التي سيتم تشغيلها من ملف الإعدادات بدلاً من الكود الثابت.
*   **التعامل مع الحذف**: حاليًا، لا يتعامل السكربت مع حذف السجلات في المصدر. يمكن إضافة منطق لاكتشاف السجلات المحذوفة وتعطيلها أو حذفها في الوجهة.
*   **تحسين الأداء**: بالنسبة لقواعد البيانات الكبيرة جدًا، قد تكون هناك حاجة لتحسينات إضافية في استعلامات البحث أو معالجة الدفعات.